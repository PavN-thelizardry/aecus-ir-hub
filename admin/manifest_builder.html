<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IR Hub Manifest Builder</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; max-width: 1000px; }
    textarea { width: 100%; height: 300px; }
    button { margin: 0.25rem 0.5rem 0.25rem 0; }
    .ok { color: green; }
    .err { color: red; }
    .small { font-size: 0.9em; color: #555; }
    pre { background: #f6f8fa; padding: 1rem; border-radius: 6px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>IR Hub Manifest Builder</h1>
  <p>This tool scans the repository file tree and generates a <code>manifest.json</code> with absolute URLs.</p>

  <div>
    <label>Repo (owner/name): 
      <input id="repo" value="pavn-thelizardry/aecus-ir-hub">
    </label><br>
    <label>Branch: 
      <input id="branch" value="main">
    </label>
  </div>

  <div>
    <button id="btnBuild">Build Manifest</button>
    <button id="btnValidate">Validate URLs</button>
    <span id="urlCheckStatus" class="small"></span>
  </div>

  <h2>Manifest Output</h2>
  <pre id="manifestOut"></pre>

  <script>
  const $ = id => document.getElementById(id);

  // Helpers to guess metadata
  function inferDocId(company, year, kind, filename) {
    return `${company}-${year}-${kind}-${filename}`.replace(/\W+/g, '-').toLowerCase();
  }
  function guessTitle(filename) {
    return filename.replace(/[_-]+/g, ' ').replace(/\.[^.]+$/, '');
  }

  async function buildManifest() {
    const [owner, repo] = $('repo').value.split('/');
    const branch = $('branch').value.trim();
    const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${encodeURIComponent(branch)}?recursive=1`;

    const res = await fetch(treeUrl, { headers: { Accept: "application/vnd.github+json" } });
    if (!res.ok) { alert("Failed to fetch repo tree"); return; }
    const j = await res.json();

    const files = (j.tree||[]).filter(n => 
      n.type === "blob" &&
      /^ir-hub\/companies\/[^/]+\/\d{4}\/(reports|transcripts)\/.+\.(pdf|txt)$/i.test(n.path)
    );

    const companies = {};

    files.forEach(f => {
      const m = f.path.match(/^ir-hub\/companies\/([^/]+)\/(\d{4})\/(reports|transcripts)\/(.+)$/i);
      if (!m) return;
      const [_, company, year, kind, filename] = m;
      if (!companies[company]) companies[company] = {};
      if (!companies[company][year]) companies[company][year] = [];

      companies[company][year].push({
        doc_id: inferDocId(company, year, kind, filename),
        type: kind === 'reports' ? 'report' : 'transcript',
        title: guessTitle(filename),
        path: f.path,
        url_pages: `https://pavn-thelizardry.github.io/${repo}/${f.path}`,
        url_raw: `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${f.path}`,
        hash: f.sha ? `git:${f.sha}` : null,
        pages: null
      });
    });

    const manifest = {
      generated_at: new Date().toISOString(),
      companies: Object.entries(companies).map(([company, years]) => ({
        company,
        years: Object.entries(years).map(([year, docs]) => ({
          year,
          docs
        }))
      }))
    };

    $('manifestOut').textContent = JSON.stringify(manifest, null, 2);
  }

  async function validateUrls() {
    const txt = $('manifestOut').textContent.trim();
    if (!txt) { alert("Build the manifest first"); return; }
    const m = JSON.parse(txt);
    const docs = m.companies.flatMap(c => c.years.flatMap(y => y.docs));

    let ok = 0, fail = 0;
    async function check(u) {
      try {
        const r = await fetch(u, { method: 'GET', headers: { 'Range': 'bytes=0-64' } });
        return r.ok;
      } catch { return false; }
    }

    for (const d of docs) {
      const good = (d.url_pages && await check(d.url_pages)) || (d.url_raw && await check(d.url_raw));
      if (good) ok++; else fail++;
    }

    $('urlCheckStatus').innerHTML = (fail===0)
      ? `<span class="ok">✔ All ${ok} URLs reachable</span>`
      : `<span class="err">✖ ${fail} of ${ok+fail} docs unreachable — check paths/case/branch</span>`;
  }

  $('btnBuild').onclick = buildManifest;
  $('btnValidate').onclick = validateUrls;
  </script>
</body>
</html>
